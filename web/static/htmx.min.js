(function(){
  var htmx = {
    process: function(elt) {
      var elements = elt.querySelectorAll('[hx-get], [hx-post], [hx-put], [hx-delete]');
      elements.forEach(function(el) {
        var method = el.getAttribute('hx-get') ? 'GET' :
            el.getAttribute('hx-post') ? 'POST' :
                el.getAttribute('hx-put') ? 'PUT' : 'DELETE';
        var events = [];

        // Only listen to submit for forms, click for everything else
        if (el.tagName === 'FORM') {
          events = ['submit'];
        } else {
          events = ['click'];
        }

        events.forEach(function(evt) {
          el.addEventListener(evt, function(e) {
            e.preventDefault();

            var url = el.getAttribute('hx-' + method.toLowerCase()) ||
                (el.tagName === 'FORM' ? el.action : '');
            var target = document.querySelector(el.getAttribute('hx-target') || 'body');
            var swap = el.getAttribute('hx-swap') || 'innerHTML';

            var formData = null;
            if (el.tagName === 'FORM') {
              formData = new FormData(el);
            }

            fetch(url, { method: method, body: formData })
                .then(r => r.text())
                .then(html => {
                  if (swap === 'innerHTML') target.innerHTML = html;
                  else if (swap === 'outerHTML') target.outerHTML = html;
                  else if (swap.includes('afterbegin')) target.insertAdjacentHTML('afterbegin', html);
                  htmx.process(target);
                });
          });
        });
      });
    }
  };
  window.htmx = htmx;
  document.addEventListener('DOMContentLoaded', function() { htmx.process(document.body); });
})();
